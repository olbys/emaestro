<!DOCTYPE html>
<html>
<head>
    <head>

        <script src="https://code.jquery.com/jquery-2.1.0.js"></script>
        <script src="server.js" type="text/javascript"></script>
        <link rel="stylesheet"
              href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic&amp;subset=latin">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700">
        <link rel="stylesheet"
              href="https://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i">
        <link rel="stylesheet" href="assetss/bootstrap-material-design-font/css/material.css">
        <link rel="stylesheet" href="assetss/tether/tether.min.css">
        <link rel="stylesheet" href="assetss/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assetss/animate.css/animate.min.css">
        <link rel="stylesheet" href="assetss/theme/css/style.css">
        <link rel="stylesheet" href="assetss/mobirise/css/mbr-additional.css" type="text/css">

        <script type="text/javascript" src="Mediarecorder.js"></script>
        <meta charset="UTF-8"/>
    </head>


</head>

<title>eMaestro</title>
<meta charset="utf-8"/>
</head>

<body style="background-color:#d1c2c2;">


<div class="container">
    <div class="row justify-content-center">
        <h1>eMaestro</h1>
    </div>
</div>


</body>

<div id="score">
    
    <form>
        <div class="form-group">
            <div id="chooseg">
                <label for="choosegroup">Choisir un groupe</label>
                <select class="form-control" id="choosegroup">
                </select>
            </div>
            <br>
            <div id ="pagecreategroup">
            <input class="btn btn-primary" type="button" onclick="window.location.href = 'defineGroup.html';" value="Créer un nouveau groupe"/>
        </div>
            <br>
            <div class="col col-lg-2">
                <label for="scoretitle">Titre de la partition</label>
                <input class="form-control" id="scoretitle" type="text"></input>
            </div>
            <div class="col col-lg-2">
                <label for="scorefilename">Nom du fichier</label>
                <input class="form-control" id="scorefilename" type="text"></input>

            </div>
            <div class="col col-lg-2">
                <label for="scoresize">Nombre de mesure</label>
                <input class="form-control" id="scoresize" type="number"></input>
            </div>
            <div class="col col-lg-2">
                <label for="currentbar">Selectionner une mesure</label>
                <input class="form-control" id="currentbar" type="number"></input>
            </div>
        </div>
    </form>

</div>

<div id="bar">
    <form>
        <div class="col col-lg-2">
            <label for="tempo">Tempo (beat/min)</label>
            <input class="form-control" id="tempo"></input>
        </div>
        <div class="col col-lg-2">
            <label for="beat">Beat</label>
            <select class="form-control" id="beat">
                <option value="">...</option>
                <option value=2>2nd</option>
                <option value=4>4th</option>
                <option value=8>8th</option>
                <option value=3>dotted 2nd</option>
                <option value=6>dotted 4th</option>
                <option value=12>dotted 8th</option>
            </select>
        </div>
        <div class="col col-lg-2">
            <label for="key">Armure</label>
            <select class="form-control" id="key">
                <option value="">...</option>
                <option value=-7>B (7 b)</option>
                <option value=-6>Gb (6 b)</option>
                <option value=-5>Db (5 b)</option>
                <option value=-4>Ab (4 b)</option>
                <option value=-3>Eb (3 b)</option>
                <option value=-2>Bb (2 b)</option>
                <option value=-1>F (1 b)</option>
                <option value=0>C (no accidental)</option>
                <option value=1>G (1 #)</option>
                <option value=2>D (2 #)</option>
                <option value=3>A (3 #)</option>
                <option value=4>E (4 #)</option>
                <option value=5>B (5 #)</option>
                <option value=6>F# (6 #)</option>
                <option value=7>C# (7 #)</option>
            </select>
        </div>
        <div class="col col-lg-2">
            <label for="time">Nombre de beat par mesure</label>
            <select class="form-control" id="time">
                <option value="">...</option>
                <option value=2>2</option>
                <option value=3>3</option>
                <option value=4 selected>4</option>
                <option value=5>5</option>
                <option value=6>6</option>
                <option value=7>7</option>
                <option value=8>8</option>
            </select>
        </div>
        <div class="col col-lg-2">
            <label for="division">Division du beat</label>
            <select class="form-control" id="division">
                <option value="">...</option>
                <option value=1>Simple</option>
                <option value=2>Compound</option>
            </select>
        </div>

        <div class="col col-lg-2">
            <label for="intensity">Intensité</label>
            <select class="form-control" id="intensity" style="font-weight: bold;font-style: italic;">
                <option value="">...</option>
                <option value=0>piano</option>
                <option value=1>pp</option>
                <option value=2>p</option>
                <option value=3>mp</option>
                <option value=4>mf</option>
                <option value=5>f</option>
                <option value=6>ff</option>
                <option value=7>fff</option>
            </select>
        </div>
        <div class="col col-lg-2">
            <label for="alert">Alerte</label>
            <select class="form-control" id="alert">
                <option value="-1">no alert</option>
                <option value="">...</option>
                <option value=0>Violet</option>
                <option value=1>Blue</option>
                <option value=2>Greenish Blue</option>
                <option value=3>Bluish Green</option>
                <option value=4>Green</option>
                <option value=5>Yellow</option>
                <option value=6>Orange</option>
                <option value=7>Red</option>
            </select>
        </div>
        <div class="col col-lg-2">
            <label for="instrument">Pupitre</label>
            <select class="form-control" id="instrument" style="font-weight: bold;font-style: italic;">
                <option value="">...</option>
               <!-- <option value=0>piano</option>-->
            </select>
        </div>
        <br>
    </form>
</div>
<!--<form>
    <div class="pupitre">
        <div class="infopupitre" id="infopupitre">
            <label for="nompupitre">Nom du pupitre</label>
            <input class="form-control" id="nompupitre" type="text"></input>
        </div>
        <div>
            <img src="assetss/images/plus.png" width="50" onclick="addPupitre()">
        </div>
    </div>
</form>-->

<!--<form>
    <div class="pupitre">
        <div class="pupitreinsertion">
        <label for="pupitrename">Nom du pupitre</label>
        <input class="form-control" id="pupitrename" type="text"></input>
        </div>
        <div>
        <img src="assetss/images/plus.png" width="50">
        </div>
    </div>
</form>-->

</div>
<br>

<div id="cancel">
    <button class="btn btn-primary">Annuler</button>
</div>

<br>
<div id="save">
    <button class="btn btn-primary">Enregistrer les caractéristiques</button>
</div>
<br>

<div id="choose">
    <button class="btn btn-primary" id="choosebutton">Choisir un morceau</button>
    <ul id="choosescore">
        <li id="afterlastscore" style="display: none">After last score</li>
    </ul>
    <button class="btn btn-primary" id="chooserecord">Choisir un enregistrement</button>
        <ul id="recordchoose">
            <li id="afterlastrecord" style="display: none">After last score</li>
        </ul>
    </div>
</div>



<!--    <button id="choosebuttongroup">Choose group</button>
    <ul id="choosegroup">
        <li id="afterlastgroup" style="display: none">After last group</li>
    </ul>-->


<!--<div id="test">
    <button>Cancel choose score</button>
</div>-->
<br>
<!--<div id="ecoute">
    &lt;!&ndash;<button id="ecouteson">Ecouter</button>&ndash;&gt;
    <audio controls>
        <source src="sons/son1.mp3" type="audio/mp3">
    </audio>
</div>-->

<!--<br>
<div id="play">
    <button class="btn btn-primary" id="playscore">Démarrer</button>
    <button class="btn btn-primary" id="stopscore">Stop</button>
    <svg id="emaestrobox"></svg>
</div>
<br>-->

<div style="border: dashed; border-width: 2px 4px;border-radius: 40px;">
    <main>
        <br><br> <br>
        <p>Emaestro Media Recorder</p>
        <div class="col col-lg-2">
            <p><button class="btn btn-primary" id="btnStart" onclick="alertt();">Démarrer l'enregistrement</button><br/>
             <label id="lab1">l'enregistrement a démarrer</label>
         </div>

        <div class="col col-lg-2">
            <button class="btn btn-primary" id="btnStop">Arrêter l'enregistrement</button>
        </div>

        <div class="col col-lg-2">
            <button class="btn btn-primary" id="btnsave">Télécharger</button>
        </div>


        <video hidden controls></video>



        <video id="vid2" controls></video>
        <br> <br>

        <form method="POST" enctype="multipart/form-data" action="/">
            <div class="col col-lg-4">
                <label >Télécharger votre piste sur emaestro</label>
                <input class="form-control" type="file" name="file">
            </div>
            <div class="col col-lg-2">
                <br>
                <input class="form-control" type="submit" value="Upload">
            </div>
        </form>
    </main>
</div>

<br>

<div id="play">
    <button class="btn btn-primary" id="playscore">Démarrer le métronome</button>
    <button class="btn btn-primary" id="stopscore">Arrêter le métronome</button>


<br>
    <br>
<button class="btn btn-primary" id="playscorerecord">Démarrer le métronome et l'enregistrement</button>
    <button class="btn btn-primary" id="stopscorerecord">Arrêter le métronome et l'enregistrement</button>

    <br>
    <center>
        <svg width="75%" height="30%"  id="emaestrobox" viewBox="0 0 100 100"
        xmlns="http://www.w3.org/2000/svg">
        </svg>
      </center>
</div>


<br>

<!--<audio class="my_audio" controls preload="none">
    <source class="son1" src="sons/son3.mp3" type="audio/mp3"/>
    <source class="son2" src="sons/son2.mp3" type="audio/mp3"/>
</audio>
<button onclick="play_audio('play')">PLAY</button>
<button onclick="play_audio('stop')">STOP</button>-->

<br>
<br>
<script>
    
     document.getElementById("lab1").style.display = 'none';

function alertt(){
    document.getElementById("lab1").style.display = 'block';

}


    var socket;
    var theScore;
    var newScoreTemplate = {
        choosegroup: "",
        scoretitle: "Mon premier morceau",
        scorefilename: "premiermorceau",
        scoresize: 4,
        currentbar: 0, // warning ! the user must see bar numbers starting at 1
        bars: []
    };

    var firstBarTemplate = {
        tempo: 80,
        beat: 4,
        key: 1,
        time: 4,
        division: 1,
        intensity: 4,
        alert: ""
    };

    var otherBarTemplate = {
        tempo: "",
        beat: "",
        key: "",
        time: "",
        division: "",
        intensity: "",
        alert: ""
    };

    function addPupitre() {
        console.log("Test");
        $("#infopupitre").before('<label for="nompupitre">Nom du pupitre</label>' + '<input class="form-control" id="nompupitre" type="text"></input>'
            );
        document.getElementById("infopupitre").innerHTML = infoPupitre;
    };
    $("#add button").click(add);

    function cancelScore() {
        console.log("cancelScore");
        theScore = instantiateJSScore(newScoreTemplate, firstBarTemplate);
        instantiateDOMScore(theScore);
    };
    $("div#cancel button").click(cancelScore);

    function instantiateJSScore(newScoreTemplate, firstBarTemplate) {
        var newScore = JSON.parse(JSON.stringify(newScoreTemplate));
        newScore.bars[0] = JSON.parse(JSON.stringify(firstBarTemplate));
        console.log("the JS score: " + JSON.stringify(newScore));
        return newScore;
    };


    function instantiateDOMScore(aScore) {
        $("div#bar select#choosegroup option[value=" + aScore.choosegroup + "]").prop('selected', true);
        $("div#score input#scoretitle").val(aScore.scoretitle);
        $("div#score input#scorefilename").val(aScore.scorefilename);
        $("div#score input#scoresize").val(aScore.scoresize);
        $("div#score input#currentbar").val(aScore.currentbar + 1);
        console.log("AAAA" + aScore.choosegroup);

        instantiateDOMCurrentBar(aScore, aScore.currentbar);
    };

    function instantiateDOMCurrentBar(aScore, currentBarNum) {
        console.log("the score: " + JSON.stringify(aScore));
        console.log("current bar num: " + currentBarNum);
        $("div#bar input#tempo").attr("value", aScore.bars[currentBarNum].tempo);
        $("div#bar select#beat option[value=" + aScore.bars[currentBarNum].beat + "]").prop('selected', true);
        $("div#bar select#key option[value=" + aScore.bars[currentBarNum].key + "]").prop('selected', true);
        $("div#bar select#time option[value=" + aScore.bars[currentBarNum].time + "]").prop('selected', true);
        $("div#bar select#division option[value=" + aScore.bars[currentBarNum].division + "]").prop('selected', true);
        $("div#bar select#intensity option[value=" + aScore.bars[currentBarNum].intensity + "]").prop('selected', true);
        $("div#bar select#alert option[value=" + aScore.bars[currentBarNum].alert + "]").prop('selected', true);
    };


</script>

<script>
    var svgns = "http://www.w3.org/2000/svg";
    var viewBox = "0 0 100 100";
    var centerBox = 32.5;
    var boxRadius = 30;                          // must be coherent with previous declarations
    var nbCircles = 4;
    var circlesRadius = [22, 16, 10, 0];         // must be coherent with previous declarations
    var circlesNbLeds = [24, 16, 8, 1];
    var circlesPhase = [0.5, 0, 0.5, 0];         // to decide at which angle led circles are positioned.
    var ledRadius = 1.5;

    function setChooseGroup() {
        theScore.choosegroup = $("#choosegroup").val();
    };
    $("#choosegroup").change(setChooseGroup);

    function setScoreTitle() {
        console.log("scoretitle:" + theScore.scoretitle);
        theScore.scoretitle = $("#scoretitle").val();
        console.log("scoretitle:" + theScore.scoretitle);
    };
    $("#scoretitle").change(setScoreTitle);

    function setScoreFileName() {
        theScore.scorefilename = $("#scorefilename").val();
    };
    $("#scorefilename").change(setScoreFileName);

    function setScoreSize() {
        var oldScoreSize = theScore.scoresize;
        theScore.scoresize = $("#scoresize").val();
        var oldScoreBars = theScore.bars;
        for (var i = 0; i < theScore.scoresize; i++) {
            // always make a deep copy of templates
            theScore.bars[i] = oldScoreBars[i] ? oldScoreBars[i] : JSON.parse(JSON.stringify(otherBarTemplate))
        }
        ;
    };
    $("#scoresize").change(setScoreSize);

    // changing the current bar do not modify the JS score, but the DOM bar must be updated
    function setCurrentBar() {
        theScore.currentbar = $("#currentbar").val() - 1;
        console.log("current bar: " + theScore.currentbar);
        instantiateDOMCurrentBar(theScore, theScore.currentbar);
    };
    $("#currentbar").change(setCurrentBar);

    function setTempo() {
        theScore.bars[theScore.currentbar].tempo = $("#tempo").val();
    };
    $("#tempo").change(setTempo);

    function setBeat() {
        theScore.bars[theScore.currentbar].beat = $("#beat").val();
    };
    $("#beat").change(setBeat);

    function setKey() {
        theScore.bars[theScore.currentbar].key = $("#key").val();
    };
    $("#key").change(setKey);

    function setTime() {
        theScore.bars[theScore.currentbar].time = $("#time").val();
    };
    $("#time").change(setTime);

    function setDivision() {
        theScore.bars[theScore.currentbar].division = $("#division").val();
    };
    $("#division").change(setDivision);

    function instantiateMaestroBox() {
        var svgPanel = document.getElementById("emaestrobox");
        svgPanel.setAttributeNS(null, "viewBox", viewBox);

        // create an encasing grey rectangle
        var rect = makeRect('0', '0', '65', '65', 'fill: grey');
        svgPanel.appendChild(rect);

        // create a round black box
        var box = makeCircle(centerBox, centerBox, boxRadius, 'fill: black');
        svgPanel.appendChild(box);

        var ledNum = 0;
        for (var c = 0; c < nbCircles; c++) {
            // every led circle is marked by a thin line (purely decorative)
            var innerCircle = makeCircle(centerBox, centerBox, circlesRadius[c],
                "stroke: grey; stroke-width: 0.05;");
            svgPanel.appendChild(innerCircle);

            // then leds are created according to the configuration declared above
            for (var i = 0; i < circlesNbLeds[c]; i++) {
                angle = 2 * Math.PI * (i + circlesPhase[c]) / circlesNbLeds[c];
                cx = centerBox + circlesRadius[c] * Math.sin(angle);
                cy = centerBox - circlesRadius[c] * Math.cos(angle);
                var led = makeCircle(cx, cy, ledRadius, "stroke: grey; stroke-width: 0.2;");
                led.setAttributeNS(null, 'id', "led" + ledNum);
                svgPanel.appendChild(led);
                ledNum++;
            }
            ;
        }
        ;
    };
//
    function makeRect(x, y, width, height, style) {
        var rect = document.createElementNS(svgns, 'rect');
        rect.setAttributeNS(null, 'x', x);
        rect.setAttributeNS(null, 'y', y);
        rect.setAttributeNS(null, 'width', width);
        rect.setAttributeNS(null, 'height', height);
        rect.setAttributeNS(null, 'style', style);
        return rect
    };

    function makeCircle(cx, cy, r, style) {
        var circle = document.createElementNS(svgns, 'circle');
        circle.setAttributeNS(null, 'cx', cx);
        circle.setAttributeNS(null, 'cy', cy);
        circle.setAttributeNS(null, 'r', r);
        circle.setAttributeNS(null, 'style', style);
        return circle
    };

    $(function () {
        theScore = instantiateJSScore(newScoreTemplate, firstBarTemplate);
        instantiateDOMScore(theScore);
        instantiateMaestroBox();
        readGroupNames();
    });

    var initClock = 1 * 1000; // a laps time before starting
    var startClock;
    var listTimers = [];

    var nbLedsPerBeat = [0, 0, 12, 8, 6, 4, 4, 3, 3]; // to check: i*unary[i] =< 24

    var nbLedsPerPulse = [
        [0, 0, 12, 8, 6, 4, 4, 3, 3], // unary - to check: i*unary[i] =< 24
        [0, 0, 6, 4, 3, 2, 2, 1, 1], // binary - to check: 2*i*unary[i] =< 24
        [0, 0, 4, 2, 2, 1, 1, 1, 1]  // ternary - to check: 3*i*unary[i] =< 24
    ];

    var intensityColors = ["#660099", "#0000ff", "#0099ff", "#33ffcc", "#33ff00", "#ffff00", "#ff6600", "#ff0000", "#aaaaaa"];

    function setIntensity() {
        theScore.bars[theScore.currentbar].intensity = $("#intensity").val();
    };
    $("#intensity").change(setIntensity);


    const EMAESTRO_ON = 0x80
    const EMAESTRO_OFF = 0x81

    function lightPulse(onoff, completedBar, theBeat, thePulse, nbPulse) {
        var d = new Date();
        var clock = d.getTime() - startClock;
//	console.log("light " + onoff + " pulse num:" + thePulse + " at " + clock);
        var nbLeds = nbLedsPerPulse[nbPulse - 1][completedBar.time];
        var firstLed = theBeat * nbLedsPerBeat[completedBar.time] + thePulse * nbLeds;
//	console.log("led " + onoff + ": from " + firstLed + " to " + (firstLed+nbLeds));
        for (var i = 0; i < nbLeds; i++) {
            document
                .getElementById("led" + (firstLed + i))
                .setAttribute("fill",
                    onoff == "on" ? intensityColors[completedBar.intensity] : "black");
        }
        ;
        socket.emit('message', (onoff == "on" ? EMAESTRO_ON : EMAESTRO_OFF) + firstLed + nbLeds + intensityColors[completedBar.intensity]);
    };

    function mySetTimeout(fun, time) {
        var timer = setTimeout(fun, time);
        listTimers.push(timer);
    };


    function playStart(theClock, theBar) {
        theBar = JSON.parse(JSON.stringify(theBar));
        theBar.intensity = 8;
        var nbPulse = 3;
        var beatTime = (1000 * 60) / theBar.tempo;
        var pulseTime = beatTime / nbPulse;
        for (var i = 0; i < theBar.time; i++) {
            (function (theBeat) {
                var lightPulseOn = function () {
                    lightPulse("on", theBar, theBeat, 0, nbPulse);
                };
                mySetTimeout(lightPulseOn, theClock);
            })(i);
            theClock += pulseTime;
            theClock += 2 * pulseTime;
        }
        ;
        return theClock;
    };

    function completeBar(theCompletedBar, theBar) {
        console.log("old completed bar: " + JSON.stringify(theCompletedBar));
        console.log("the score bar: " + JSON.stringify(theScore.bars[theBar]));
        theCompletedBar.alert = "";
        var newAlert = false;
        const barAttributes = ["tempo", "time", "beat", "intensity", "key", "division"];
        barAttributes.forEach(
            attr => {
                if (theScore.bars[theBar][attr] != "") {
                    theCompletedBar[attr] = theScore.bars[theBar][attr];
                    newAlert = true;
                }
                ;
            }
        );
        if (theScore.bars[theBar].alert == -1) {
            theCompletedBar.alert = "";
        } else if (theBar == 0) {
            theCompletedBar.alert = "";
        } else if (theScore.bars[theBar].alert != "") {
            theCompletedBar.alert = theScore.bars[theBar].alert;
        } else if (newAlert) {
            theCompletedBar.alert = theCompletedBar.intensity;
        }
        ;
        console.log("new completed bar: " + JSON.stringify(theCompletedBar));
        return theCompletedBar;
    }

    function lightKey(completedBar) {
        console.log("change in key");
        var firstLed = circlesNbLeds[0] + circlesNbLeds[1];
        var nbLeds = circlesNbLeds[2];
        console.log("switch off key circle: from " + firstLed + " to " + (firstLed + nbLeds));
        for (var i = 0; i < nbLeds; i++) {
            document.getElementById("led" + (firstLed + i))
                .setAttribute("fill", "black");
        }
        ;

        var key = completedBar.key;
        console.log("switch on key circle with new key: " + key);
        if (key < 0) {
            nbLeds = -key;
            firstLed = circlesNbLeds[0] + circlesNbLeds[1] + circlesNbLeds[2] - nbLeds;
        } else {
            nbLeds = key;
            firstLed = circlesNbLeds[0] + circlesNbLeds[1];
        }
        ;
        console.log("first led = " + firstLed + " ; nbLeds = " + nbLeds);
        for (var i = 0; i < nbLeds; i++) {
            document
                .getElementById("led" + (firstLed + i))
                .setAttribute("fill", intensityColors[completedBar.intensity]);
        }
        ;
    };


    function playKey(theClock, completedBar) {
        mySetTimeout(function () {
                lightKey(completedBar);
            },
            theClock
        );
    };

    var blinkProgram = [0, 200, 600, 800];

    function lightBlink(onoff, theCompletedBar) {
        console.log("play blink: " + JSON.stringify(theCompletedBar) + onoff);
        var firstLed = circlesNbLeds[0];
        var nbLeds = circlesNbLeds[1];
        var color = intensityColors[theCompletedBar.alert];
        console.log("alert color" + color);
        for (var i = 0; i < nbLeds; i++) {
            document
                .getElementById("led" + (firstLed + i))
                .setAttribute("fill", onoff == "on" ? color : "black");
        }
        ;
        var lastLed = circlesNbLeds[0] + circlesNbLeds[1] + circlesNbLeds[2];
        document.getElementById("led" + lastLed)
            .setAttribute("fill", onoff == "on" ? color : "black");
    };

    function playAlert(theClock, theCompletedBar) {
        console.log("play alert: " + JSON.stringify(theCompletedBar));
        if (theCompletedBar.alert != "") {
            for (var i = 0; i < blinkProgram.length; i++) {
                mySetTimeout(function () {
                        lightBlink("on", theCompletedBar);
                    },
                    theClock + blinkProgram[i]
                );
                i++;
                mySetTimeout(function () {
                        lightBlink("off", theCompletedBar);
                    },
                    theClock + blinkProgram[i]
                );
            }
            ;
        }
        ;
    };

    function playBeat(theClock, completedBar, theBeat) {
        var nbPulse;
        if (completedBar.division == 1) {
            nbPulse = 1;
        } else if (completedBar.beat == 2 || completedBar.beat == 4 || completedBar.beat == 8) {
            nbPulse = 2;
        } else {
            nbPulse = 3;
        }
        ;

        var beatTime = (1000 * 60) / completedBar.tempo;
        var pulseTime = beatTime / nbPulse;
        for (var i = 0; i < nbPulse; i++) {
//	console.log("play pulse num:" + i + " at " + theClock + "on");
            (function (thePulse) {
                var lightPulseOn = function () {
                    lightPulse("on", completedBar, theBeat, thePulse, nbPulse);
                };
                mySetTimeout(lightPulseOn, theClock);
            })(i);
        }
        ;
        for (var i = 0; i < nbPulse; i++) {
            theClock += pulseTime;
//	console.log("play pulse num:" + i + " at " + theClock + "off");
            (function (thePulse) {
                var lightPulseOff = function () {
                    lightPulse("off", completedBar, theBeat, thePulse, nbPulse);
                };
                mySetTimeout(lightPulseOff, theClock);
            })(i);
        }
        ;
        return theClock;
    };

    function playBar(theClock, theCompletedBar, theBar) {
// completion of the completed bar
        theCompletedBar = completeBar(theCompletedBar, theBar);
        playKey(theClock, theCompletedBar);
        playAlert(theClock, theCompletedBar);
        for (var i = 0; i < theCompletedBar.time; i++) {
//console.log("play beat num:" + i + " at " + theClock);
            theClock = playBeat(theClock, theCompletedBar, i);
        }
        ;
        return theClock;
    };

    function lightOff() {
        var nbLeds = 49;
        for (var i = 0; i < nbLeds; i++) {
            document.getElementById("led" + i).setAttribute("fill", "black");
        }
        ;
    };

    function playEnd(theClock) {
        mySetTimeout(function () {
            lightOff();
        }, theClock);
        return theClock + 10;
    };

    function playScore() {
        var d = new Date();
        startClock = d.getTime();
        var theClock = initClock;
        theClock = playStart(theClock, theScore.bars[0]);
// bars in theScore only mark changes
// a completed bar is created to remember what does not change
// it is cloned then updated while reading each bar in turn
        var completedBar = theScore.bars[0];
        for (var i = 0; i < theScore.scoresize; i++) {
            // starts the bar handler
            // the bar handler will start the beats and pulses handlers
            // and return an updated time
            console.log("play bar num:" + i + JSON.stringify(theScore.bars[i]) + " at " + theClock);
            // do not forget to clone the completed bar
            completedBar = JSON.parse(JSON.stringify(completedBar));
            theClock = playBar(theClock, completedBar, i);
        }
        ;
        theClock = playEnd(theClock);
    };
    $("div#play button#playscore").click(playScore);

    function playScoreRecord() {

        let btnstart = document.getElementById('btnStart');
       btnstart.click();

        var d = new Date();
        startClock = d.getTime();
        var theClock = initClock;
        theClock = playStart(theClock, theScore.bars[0]);
// bars in theScore only mark changes
// a completed bar is created to remember what does not change
// it is cloned then updated while reading each bar in turn
        var completedBar = theScore.bars[0];
        for (var i = 0; i < theScore.scoresize; i++) {
            // starts the bar handler
            // the bar handler will start the beats and pulses handlers
            // and return an updated time
            console.log("play bar num:" + i + JSON.stringify(theScore.bars[i]) + " at " + theClock);
            // do not forget to clone the completed bar
            completedBar = JSON.parse(JSON.stringify(completedBar));
            theClock = playBar(theClock, completedBar, i);
        }
        ;
        theClock = playEnd(theClock);
    };
    $("div#play button#playscorerecord").click(playScoreRecord);



    function stopScoreRecord() {

        let stop = document.getElementById('btnStop');
        stop.click();
        theClock = playEnd(theClock);
    };
    $("div#play button#stopscorerecord").click(stopScoreRecord);



    var fileContent = "";

    function saveScore() {
        var fileName = $("div#score input#scorefilename").val();
        var req = new XMLHttpRequest();
        var fileContent = JSON.stringify(theScore);

        req.onreadystatechange = function (event) {
// XMLHttpRequest.DONE === 4
            if (this.readyState === XMLHttpRequest.DONE) {
                if (this.status === 200) {
                    console.log("Réponse reçue: %s", this.responseText);
                } else {
                    console.log("Status de la réponse: %d (%s)",
                        this.status, this.statusText);
                }
            }
        };

        req.open("PUT", "/SCORES/" + fileName, true);
        req.send(JSON.stringify(theScore));
    };
    $("#save button").click(saveScore);


    var affichage = false;

    function readScoreNames() {
        var req = new XMLHttpRequest();

        req.onreadystatechange = function (event) {
            // XMLHttpRequest.DONE === 4
            if (this.readyState === XMLHttpRequest.DONE) {
                if (this.status === 200) {
                    console.log("Réponse reçue: %s", this.responseText);
                    buildScoreSelector(JSON.parse(this.responseText));
                } else {
                    console.log("Status de la réponse: %d (%s)",
                        this.status, this.statusText);
                }
            }
        };
        req.open("GET", "/SCORES/", true);
        req.send(null);
    }

    $('#choosebutton').on('click', readScoreNames);

    var a = "";

    function buildScoreSelector(scoreList) {
        console.log("buildScoreSelector " + scoreList);
        for (var i in scoreList.scores) {
            $("#afterlastscore").before('<li class="onescore">' + "<button>" + scoreList.scores[i] + "</button>" + "</li>");
            console.log("onclick: " + scoreList.scores[i]);
            console.log("#choosescore button:contains('" + scoreList.scores[i] + "'):" + $("#choosescore button:contains('" + scoreList.scores[i] + "')"));

            (function (target) {
                $("#choosescore button:contains('" + scoreList.scores[target] + "')").on('click', readScoreByName(scoreList.scores[target]));
                $("#choosescore button:contains('" + scoreList.scores[target] + "')").attr('value', scoreList.scores[target]);
            })(i);
        }
        ;
    }

    function readRecordNames() {
        var req = new XMLHttpRequest();

        req.onreadystatechange = function (event) {
            // XMLHttpRequest.DONE === 4
            if (this.readyState === XMLHttpRequest.DONE) {
                if (this.status === 200) {
                    console.log("Réponse reçue: %s", this.responseText);
                    buildRecordSelector(JSON.parse(this.responseText));
                } else {
                    console.log("Status de la réponse: %d (%s)",
                        this.status, this.statusText);
                }
            }
        };
        req.open("GET", "/sons/", true);
        req.send(null);
    }
    $('#chooserecord').on('click', readRecordNames);

    function buildRecordSelector(recordList) {
        for (var i in recordList.scores) {
            $("#afterlastrecord").before('<li class="onerecord">' + "<p>" + recordList.scores[i] + "</p>" + "</li>" +
                '<audio controls>' + '<source src="sons/' + recordList.scores[i] +'"'+ 'type="audio/mp3">' + '</audio>');

            (function (target) {
                $("#recordchoose button:contains('" + recordList.scores[target] + "')").on('click', readScoreByName(recordList.scores[target]));
                $("#recordchoose button:contains('" + recordList.scores[target] + "')").attr('value', recordList.scores[target]);
            })(i);
        }
        ;
    }

    function test() {
        console.log("Test");
    }

    $("#test button").click(test);


    function readScoreByName(name) {
        console.log("readScoreByName:" + name);
        return function readOneScore() {
            console.log("readOneScore: " + name);
            var req = new XMLHttpRequest();

            req.onreadystatechange = function (event) {
                // XMLHttpRequest.DONE === 4
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this.status === 200) {
                        console.log("Réponse reçue: %s", this.responseText);
                        theScore = JSON.parse(this.responseText);
                        instantiateDOMScore(theScore);
                    } else {
                        console.log("Status de la réponse: %d (%s)",
                            this.status, this.statusText);
                    }
                }
            };

            req.open("GET", "/SCORES/" + name, true);
            req.send(null);
        };
    }

    function readRecordByName(name) {
        return function readOneRecord() {
            var req = new XMLHttpRequest();

            req.onreadystatechange = function (event) {
                // XMLHttpRequest.DONE === 4
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this.status === 200) {
                        console.log("Réponse reçue: %s", this.responseText);
                        theScore = JSON.parse(this.responseText);
                        instantiateDOMScore(theScore);
                    } else {
                        console.log("Status de la réponse: %d (%s)",
                            this.status, this.statusText);
                    }
                }
            };

            req.open("GET", "/sons/" + name, true);
            req.send(null);
        };
    }

    // Afficher la liste des groupes
    function readGroupNames() {
        var req = new XMLHttpRequest();

        req.onreadystatechange = function (event) {
            // XMLHttpRequest.DONE === 4
            if (this.readyState === XMLHttpRequest.DONE) {
                if (this.status === 200) {
                    console.log("Réponse reçue: %s", this.responseText);
                    buildGroupSelector(JSON.parse(this.responseText));
                } else {
                    console.log("Status de la réponse: %d (%s)",
                        this.status, this.statusText);
                }
            }
        };
        req.open("GET", "/Ensemble/", true);
        req.send(null);
    }


    var a = "";

    function buildGroupSelector(groupList) {
        console.log("buildScoreSelector " + groupList);
        for (var i in groupList.scores) {
            a = a + '<option value="' + groupList.scores[i] + '">' + groupList.scores[i] + '</option>'
            /*
                        a = a +'<li class="onegroup">' + "<button>" + groupList.scores[i] + "</button>" + "</li>"
            */
            console.log("a = " + a);
        }

        document.getElementById("choosegroup").innerHTML = a;

        (function (target) {
            if (groupList !== null) {
                $("#choosegroup button:contains('" + groupList.scores[target] + "')").on('click', readGroupByName(groupList.scores[target]));
                $("#choosegroup button:contains('" + groupList.scores[target] + "')").attr('value', groupList.scores[target]);
            }
        })(i);
    }

    function readGroupByName(name) {
        return function readOneGroup() {
            var req = new XMLHttpRequest();

            req.onreadystatechange = function (event) {
                // XMLHttpRequest.DONE === 4
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this.status === 200) {
                        console.log("Réponse reçue: %s", this.responseText);
                        group = JSON.parse(this.responseText);
                        instantiateDOMGroup(group);
                    } else {
                        console.log("Status de la réponse: %d (%s)",
                            this.status, this.statusText);
                    }
                }
            };

            req.open("GET", "/Ensemble/" + name, true);
            req.send(null);
        }
    }

    $(".my_audio").trigger('load');
    function play_audio(task) {
        if(task == 'play'){
            $(".my_audio").trigger('play');
/*
            document.getElementById('son2').play();
*/
        }
        if(task == 'stop'){
            $(".my_audio").trigger('pause');
            $(".my_audio").prop("currentTime",0);
        }
    }

</script>


</html>
